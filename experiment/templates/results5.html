<html>
<head>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.4.5/css/foundation.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.css">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.4.1/js/foundation.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script type="text/javascript" src="{{ROOKIE_JS}}"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.7/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.js"></script>
<link rel="stylesheet" href="{{ROOKIE_CSS}}"></link>
<title>Rookie</title>
{% include 'head.html' %}
</head>

<body>
{% include 'banner.html' %}

<div id="controls" class="row">

  <div>
    <div class="small-10 columns">
      <input id="search_bar" type="text" class="small-12 columns" placeholder="{{query}}"></input>
    </div>
    <div class="small-2 columns">
      <a href="#" class="button postfix" id="search_button">Search</a>
    </div>
  </div>

</div>

<!--
<div class="toggler row">
    <div class="columns small-3 right" id="datepickers">
      <div class="columns"><p>Start date: <input type="text" id="datepicker1"></p></div>
      <div class="columns"><p>End date: <input type="text" id="datepicker2"></p></div>
    </div>
</div>
-->

<div class="main-content">
  <div id="facets_list" class="small-4 columns">
    <div class="row">Common subjects in articles matching {{query}}</div>
    {% for term in terms%}
     <div class="row">
        <div class="small-5 columns class=left">
          <span id="{{term[0].replace(' ', '_')}}-label" class="term facet" data-termtype="{{term[0]}}">{{term[0].replace('_', ' ')}}</span>
        </div>
        <div class="small-7 columns class=right sparkline">
          <span id="v{{term[0]}}-chart"></span>
        </div>
     </div>
     <br>
    {% endfor %}
  </div>

  <div class="small-8 columns" id="doclist">
      <div>{{status}}</div>
      {% for doc in doc_list%}
     <div><a href='{{doc[2]}}'><span class="headline">{{doc[1]}}</span> | <span class="dateline">{{doc[0]}}</span></a>
      <div>
        <span class="urlpreview">{{doc[2]}}</span>
      </div>
      <div class="snippet">
        {{doc[3]}}
      </div>
     </div>
     {% endfor %}
     <div>
      {% if page > 1 %}
      <a data-page="{{page}}" id="back" class="page">back</a> |
      {% endif %}
      <a data-page="{{page}}" id="next" class="page">next page</a>
      </div>
  </div>
</div>

  <script type="text/javascript">
      {% for term in terms%}

      var chart2 = c3.generate({
        size: {
            height: 100,
            width: $(".sparkline").first().width()
        },
        legend: {
            show: false
        },
        axis: {
            x: {
                type: 'timeseries',
                tick: {
                    format: '%Y'
                },
                show: true
            },
            y: {
              show:false
            }
        },
        data: {
          x: 'x',
          columns: [
              {{keys | safe}},
              {{term | safe}},
              {{datas | safe}},
          ],
          type: 'timeseries',
          types: {
              '{{datas[0]}}': 'area-spline',
              '{{term[0]}}': 'line',
          },
          onclick: function (d, element) {
            var term = $("#search_bar").val();
            var start = d.x.toDateString();
            var end_date = new Date (Date.parse(start));
            var new_year = end_date.getFullYear() + 1;
            end_date.setFullYear(new_year);
            var end = end_date.toDateString();
            $.post("/get_doc_list?q=" + term + "&detail=" + encodeURIComponent(d.name) + "&startdate=" + encodeURIComponent(start) + "&enddate=" + encodeURIComponent(end), function(data){
               $("#docs").html(data);
            });
          },
        },
        tooltip: {
          grouped: false, // Default true
          format: {
              value: function (value, ratio, id, index) { return value + " articles"; },
              name: function (name, ratio, id, index) { 
                var re = new RegExp("_", 'g');
                return name.replace(re, " "); 
              }
          }
        },
        bindto: "#v{{term[0] | safe}}-chart",
      });

      {% endfor %}


      var facet_count = $(".facet").length;

      $(".facet").each(function(i, id){
        var facet = id.id.replace("-label", "");
        var axis = false;
        if (id.id.replace("-label", "") == "dummy"){
          axis = false;
        }
        // make_chart(facet, axis);
      });

      $('.page').on("click", function(e){
        var page = parseInt(this.dataset.page);
        if (this.id == "next"){
          page += 1;
        }else{
          page -= 1;
        }
        get_results(page);
      });

      $("#search_bar").val($.QueryString["q"]);

  </script>

</body>
</html>