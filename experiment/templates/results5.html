<html>
<head>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.4.5/css/foundation.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.css">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.4.1/js/foundation.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.7/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.js"></script>
<title>Rookie</title>
{% include 'head.html' %}
</head>
<style type="text/css">
    .c3-axis-y .tick {
       display: none;
    }
    span.dateline {
        color: #606060;
    }
    span.urlpreview {
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
      display: block;
      font-size: small;
      color: #C0C0C0;
    }
    .snippet{
      color:#303030;
      font-size: small; 
    }
</style>

<body>
{% include 'banner.html' %}

<div id="controls" class="row">

  <div>
    <div class="small-10 columns">
      <input id="search_bar" type="text" class="small-12 columns" placeholder="{{query}}"></input>
    </div>
    <div class="small-2 columns">
      <a href="#" class="button postfix" id="search_button">Search</a>
    </div>
  </div>

</div>

<!--
<div class="toggler row">
    <div class="columns small-3 right" id="datepickers">
      <div class="columns"><p>Start date: <input type="text" id="datepicker1"></p></div>
      <div class="columns"><p>End date: <input type="text" id="datepicker2"></p></div>
    </div>
</div>
-->

<div class="main-content">
  <div class="small-4 columns">
    <div class="row">Common subjects in articles matching {{query}}</div>
    {% for term in terms%}
     <div class="row">
        <div class="small-5 columns class='left'">
          <span id="{{term.replace(' ', '_').replace('.', '')}}-label" class="term facet" data-termtype="{{term}}">{{term}}</span>
        </div>
        <div class="small-7 columns class='right'">
          <span id="v{{term.replace(' ', '_').replace('.', '')}}-chart"></span>
        </div>
     </div>
     <br>
    {% endfor %}
  </div>

  <div class="small-8 columns" id="doclist">
      <div>{{status}}</div>
      {% for doc in doc_list%}
     <div><a href='{{doc[2]}}'><span class="headline">{{doc[1]}}</span> | <span class="dateline">{{doc[0]}}</span></a>
      <div>
        <span class="urlpreview">{{doc[2]}}</span>
      </div>
      <div class="snippet">
        {{doc[3]}}
      </div>
     </div>
     {% endfor %}
  </div>
</div>

  <script type="text/javascript">
      
      dummy =  ['count', 0, 0, 0, 0, 0, 0];

      {% for term in terms%}
         {{"v" + term.replace(" ", "_").replace('.', '')}} =  {{data[term] | safe}};
      {% endfor %}

     
      function make_chart(term, show_axis){

       c3.generate({
        bindto: "#v" + term + '-chart',
        size: {
            height: 50,
            width: 200
        },
        data: {
            x: 'x',
            columns: [
               ['x' {% for key in keys%} ,'{{key}}-01-01' {% endfor %}],
               window["v" + term]
            ],
            type: 'area-spline',
            colors: {
                  x: '#ff0000',
                  count: '#B33125'
            },
            color: function (color, d) {
                  // d will be 'id' when called for legends
                  return d.id && d.id === 'data3' ? d3.rgb(color).darker(d.value / 150) : color;
            },
        },
        tooltip: {
            show: true
        },
        legend: {
            show: false
        },
        axis: {
            x: {
                type: 'timeseries',
                tick: {
                    format: '%Y'
                },
                show: show_axis
            },
            y: {
              show:false
            }
        }
       });
      }
      
      var facet_count = $(".facet").length;

      $(".facet").each(function(i, id){
        var facet = id.id.replace("-label", "");
        var axis = false;
        if (id.id.replace("-label", "") == "dummy"){
          axis = false;
        }
        make_chart(facet, axis);
      });

  </script>

<script type="text/javascript">
$(".facet").on("click", function() {
  var term = this.id.replace("-label", "");
  var termtype = $("[id='" + this.id + "']").attr("data-termtype");
  $.post("get_snippet_post?term=" + term + "&termtype=" + termtype, function (data) {
    $("[id='detail-panel']").html(data);
    $(".extract").on("click", function () {
      var docid = this.attributes['data-doc'].value;
      var dataterm = this.attributes['data-term'].value;
      var q = $("#search_bar").val();
      var url = "http://" + "{{IP}}" + "/detail?q=" + q + "&docid=" + docid + "&t=" + dataterm;
      window.location.href = url;
    });
    bold_q();
  })
});

 jQuery.fn.exists = function(){return this.length>0;}

 if ($("#datepicker1").exists() && $("#datepicker2").exists()){
  $(function() {
    $("#datepicker1").datepicker();
  });
  $(function() {
    $("#datepicker2").datepicker();
  });
}

//wrapper for cloud search
function get_results(start){
    $("#results").html("");
    $("#search_status").html("");
    var term = $("#search_bar").val();
    var url = "http://" + "{{IP}}" + "/facets?q=" + term;
    window.location.href = url;
}

$('.page').on("click", function(e){
  $("#pages").html("");
  var start_page = parseInt(this.id.replace("page_", ""));
  get_results(start_page);
});

function bold_q(){
  var qtoks = $("#search_bar").val().split(" ");
  for (i = 0; i < qtoks.length; i++) { 
    $("[data-word='" + qtoks[i] + "']").css("font-weight", "bold");
  }
  var elementExists = document.getElementById("search_button");
  if ($('.selected').length > 0){
     var ftoks = $(".selected").first().html().split(" ");
     for (i = 0; i < ftoks.length; i++) { 
       $("[data-word='" + ftoks[i] + "']").addClass("selected");
     }  
  }
}


 $('#search_button').on('click', function(){
    get_results(1);
 });
  
 //https://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript 
 (function($) {
    $.QueryString = (function(a) {
        if (a == "") return {};
        var b = {};
        for (var i = 0; i < a.length; ++i)
        {
            var p=a[i].split('=');
            if (p.length != 2) continue;
            b[p[0]] = decodeURIComponent(p[1].replace(/\+/g, " "));
        }
        return b;
    })(window.location.search.substr(1).split('&'))
 })(jQuery);

 $("#search_bar").val($.QueryString["q"]);
 $("#advanced_search").on("click", function(){$(".toggler").toggle()});

 $('body').bind('keypress', function(e){
   if ( e.keyCode == 13 ) {
     get_results(1);
   }
 });

 $(".facet").on("click", function(){
   $(".term").removeClass("selected");
   $("[id='" + this.id + "']").addClass("selected");
 });

</script>

</body>
</html>