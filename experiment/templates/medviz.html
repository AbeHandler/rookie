<html>
<head>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.4.5/css/foundation.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.css">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.4.1/js/foundation.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.3/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.3/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js"></script>
<script type="text/javascript" src="{{ROOKIE_JS}}"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.7/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/history.js/1.8/bundled/html4+html5/jquery.history.min.js"></script>
<script src="https://s3-us-west-2.amazonaws.com/rookie2/js/nlp.js"></script>
<link rel="stylesheet" href="{{ROOKIE_CSS}}"></link>
<title>Rookie</title>
{% include 'head.html' %}
</head>

<body>
{% include 'banner.html' %}

<div id="controls" class="row">

  <div>
    <div class="small-10 columns">
      <input id="search_bar" type="text" class="small-12 columns" placeholder="{{query}}"></input>
    </div>
    <div class="small-2 columns">
      <a href="#" class="button postfix" id="search_button">Search</a>
    </div>
  </div>

</div>


<div id="content" class="main-content">
  <div class="row small-12 small-centered columns" data-detail="{{detail}}" id="chart">
  </div> 
  <div class="row">
    <div>Common subjects related to <span style="font-weight:bold">{{data[0] | safe}}</span></div>
  </div>
  <div class="row small-10 small-centered columns" id="facets">
  </div>
  
  <div class="small-12 small-centered columns row" id="doclist">

            <div>{{status | safe }}</div>
            {% for doc in doc_list%}
           <div><a target="_blank" href='{{doc[2]}}'><span class="headline">{{doc[1]}}</span></a>
            <div class="snippet"><span class="dateline">{{doc[0]}}</span>&mdash;
              {{doc[3] | safe}}
            </div>
           </div>
           {% endfor %}
           <div>
            {% if page > 1 %}
            <a data-page="{{page}}" id="back" class="page">back</a> |
            {% endif %}
            <a data-page="{{page}}" id="next" class="page">next page</a>
            </div>

  </div>

</div>

<script type="text/babel">

var History = window.History;

// Bind to StateChange Event
History.Adapter.bind(window,'statechange',function(){ // Note: We are using statechange instead of popstate
    var State = History.getState(); // Note: We are using History.getState() instead of event.state
    History.log(State.data, State.title, State.url);
});


var Name = React.createClass({
    handleClick: function(e) {
        this.props.onClick(e);
        this.forceUpdate();
    },
    render: function() {
         let tmp = this.props.color;
         var divStyle = {
            color: tmp,
            "paddingRight": "5px",
            "paddingLeft": "5px",
            "marginLeft": "3px",
            "marginRight": "3px",
            "fontWeight": this.props.fontweight,
            "borderBottomColor": this.props.borderBottomColor,
            "borderStyle":this.props.borderStyle,
            "border": '1px solid ' + this.props.borderBottomColor
         };
         var display = this.props.name.replace(/_/g, ' ');
         return (<div className="button tiny secondary" style={divStyle} name={this.props.name} onClick={this.handleClick.bind(this, this.props.name)}>
            {display}
        </div>);
    }
});


var SparkList = React.createClass({
  getInitialState(){
    return {active: -1};
  },
  handleClick: function(item) {
    chart.hide(this.state.active);
    this.setState({active: item});
    var mysrt = String(item).replace(/_/g, '-');
    console.log(mysrt);
    chart.show(item);
    var start = "NA";
    var end = "NA";
    $.post("/get_doc_list?q=" + $.QueryString["q"] + "&detail=" + encodeURIComponent(item) + "&startdate=" + encodeURIComponent(start) + "&enddate=" + encodeURIComponent(end) + "&zoom=None", function(data){
       $("#doclist").html(data);
    });
  },
  render: function() {
    return (
      <div>
        {this.props.items.map(function(item, i) {
          let csolor;
          let fontsize;
          let borderBottomColor;
          let borderBottomWidth;
          let borderStyle;
          if (this.state.active===this.props.items[i].key){
              csolor="#B33125";
              fontsize="bold";
              borderBottomColor="black";
              borderBottomWidth=5;
              borderStyle="solid";
          }else{
              csolor="grey";
              fontsize="normal";
              borderBottomColor="grey";
              borderBottomWidth=0;
              borderStyle="none";
          }
          return (
            <Name data={item.data} name={item.key} borderStyle={borderStyle} borderBottomWidth={borderBottomWidth} borderBottomColor={borderBottomColor} fontweight={fontsize} color={csolor} onClick={this.handleClick} key={i}/>
          );
        }, this)}
      </div>
    );
  }
});


var datas = [
{% for term in terms %}
  {% if loop.index < terms|length %}
   {"key": "{{term[0] | safe}}"},
  {% else %}
    {"key": "{{term[0] | safe}}"}
  {% endif %}
{% endfor %}
]

ReactDOM.render(
  <div>
  <SparkList className="button-group even-3" items={datas} /></div>,
  document.getElementById('facets')
);

</script>


<script type="text/javascript">
function get_results2() {
  var q = $("#search_bar").val();
  this.location = "/medviz?q=" + encodeURIComponent(q);
  //History.pushState(data,title,url);
}

$('body').bind('keypress', function(e){
  if (e.keyCode == 13) {
     get_results2();
  }
});

$("#search_bar").val($.QueryString["q"]);

    q_data = {{data | safe }};
    var last;
    var chart = c3.generate({
    size: {
        height: 150
    },
    data: {
        x: 'x',
        columns: [
            {{data | safe }},
            {{keys | safe}},
            {% for term in terms %}
            {% if loop.index < terms|length %}
              {{term | safe }},
              {% else %}
              {{term | safe }}
             {% endif %}
            {% endfor %}
        ],
        hide: [
          {% for term in terms %}
            {% if loop.index < terms|length %}
              '{{term[0]}}',
            {% else %}
              '{{term[0]}}'
            {% endif %}
          {% endfor %}
        ],
        colors: {
            '{{data[0] | safe}}': '#B33125',
            {% for term in terms %}
            {% if loop.index < terms|length %}
               "{{term[0] | safe}}" : "grey",
              {% else %}
                "{{term[0] | safe}}" : "grey"
              {% endif %}
             {% endfor %}
        },
        onclick: function (d, element) {
            var term = $("#search_bar").val();
            var start = d.x.toDateString();
            var end_date = new Date (Date.parse(start));
            var zoom = $("#chart").attr("data-detail");
            if (zoom == "year"){
              var new_year = end_date.getFullYear() + 1;
              end_date.setFullYear(new_year);
              var end = end_date.toDateString();
            }
            if (zoom == "month"){
              var new_mo = end_date.getMonth() + 1;
              end_date.setMonth(new_mo);
              var end = end_date.toDateString();              
            }
            var path = d3.select(element);
            if (path.style("fill") === "rgb(0, 0, 0)"){
              path.style("fill", "grey");
            }else{
               path.style("fill", "black");
               d3.select(last).style("fill", "grey");
               last = element;
            }
            $.post("/get_doc_list?q=" + term + "&detail=" + encodeURIComponent(d.name) + "&startdate=" + encodeURIComponent(start) + "&enddate=" + encodeURIComponent(end) + "&zoom=" + zoom, function(data){
               $("#doclist").html(data);
            });
        },
        bar: {
         width: 4
        },
        type: 'line',
        types: {
            '{{data[0] | safe }}': 'area-spline',
            {% for term in terms %}
            {% if loop.index < terms|length %}
               "{{term[0] | safe}}" : "bar",
              {% else %}
                "{{term[0] | safe}}" : "bar"
              {% endif %}
             {% endfor %}
        }
    },
     bindto: '#chart',
     axis: {
        x: {
            type: 'timeseries',
            tick: {
                format: '%Y',
                fit: true
            }
        }
    },
    legend: {
        show: false
    },
    tooltip: {
        grouped: false, // Default true
        format: {
            value: function (value, ratio, id, index) { return value + " articles"; }
        }
    }
});

$(".c3-chart").click(function(i,e){
  alert("D");
});

$("#search_bar").val($.QueryString["q"]);
</script>
  <style type="text/css">
      #chart .c3-circles-{{data[0].replace(" ", "-")}} {
        display: none;
      }
  </style>

</body>
</html>