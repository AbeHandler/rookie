<html>
<head>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.4.5/css/foundation.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.css">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.4.1/js/foundation.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.3/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.3/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js"></script>
<script type="text/javascript" src="{{ROOKIE_JS}}"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.7/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.js"></script>
<link rel="stylesheet" href="{{ROOKIE_CSS}}"></link>
<title>Rookie</title>
{% include 'head.html' %}
</head>

<body>
{% include 'banner.html' %}

<div id="controls" class="row">

  <div>
    <div class="small-10 columns">
      <input id="search_bar" type="text" class="small-12 columns" placeholder="{{query}}"></input>
    </div>
    <div class="small-2 columns">
      <a href="#" class="button postfix" id="search_button">Search</a>
    </div>
  </div>

</div>


<div id="content"></div>

<script type="text/babel">


var Name = React.createClass({
    handleClick: function(e) {
        this.props.onMouseOver(e);
        this.forceUpdate();
    },
    render: function() {
         let tmp = this.props.color;
         var divStyle = {
            color: tmp
         }
         return (<div style={divStyle} name={this.props.name} onMouseOver={this.handleClick.bind(this, this.props.name)}>
            {this.props.name}
        </div>);
    }
});

var SparkList = React.createClass({
  getInitialState(){
    return {active: -1};
  },
  handleClick: function(item) {
    this.setState({active: item});
    var mysrt = String(item).replace(/_/g, '-');
    console.log(mysrt);
    var css = "#chart .c3-line-" + mysrt;
    $("#chart .c3-line*").css("stroke-width", "1px");
    $(css).css("stroke-width", "10px");
  },
  render: function() {
    return (
      <div>
        {this.props.items.map(function(item, i) {
          let csolor;
          if (this.state.active===this.props.items[i].key){
              csolor="blue";
          }else{
              csolor="red";
          }
          return (
            <Name data={item.data} name={item.key} color={csolor} onMouseOver={this.handleClick} key={i}/>
          );
        }, this)}
      </div>
    );
  }
});


var datas = [
{% for term in terms %}
  {% if loop.index < terms|length %}
   {"key": "{{term[0] | safe}}", "data": [1111, 100, 25, 6]},
  {% else %}
    {"key": "{{term[0] | safe}}", "data": [1111, 100, 25, 6]}
  {% endif %}
{% endfor %}
]

ReactDOM.render(
  <SparkList items={datas} />,
  document.getElementById('content')
);

     
</script>

<div id="chart">

</div>

<script type="text/javascript">
      dummy =  ['count', 0, 0, 0, 0, 0, 0];
      q_data = {{data | safe }};
      q_labels = {{labels | safe }}
      var chart = c3.generate({
    data: {
        x: 'x',
        columns: [
           {{labels | safe }},
            {{data | safe }},
            {% for term in terms %}
              
            {% if loop.index < terms|length %}
              {{term | safe }},
              {% else %}
              {{term | safe }}
             {% endif %}
            {% endfor %}
        ],
        colors: {
            '{{data[0] | safe}}': '#B33125'
        },
        onclick: function (d, element) {
            var term = $("#search_bar").val();
            var start = d.x.toDateString();
            var end_date = new Date (Date.parse(start));
            var new_year = end_date.getFullYear() + 1;
            end_date.setFullYear(new_year);
            var end = end_date.toDateString();
            $.post("/get_doc_list?q=" + term + "&detail=" + encodeURIComponent(d.name) + "&startdate=" + encodeURIComponent(start) + "&enddate=" + encodeURIComponent(end), function(data){
               $("#docs").html(data);
            });
        },
        type: 'line',
        types: {
            '{{data[0] | safe }}': 'area-spline',
            '{{terms[0][0] | safe }}': 'line',
            '{{terms[1][0] | safe }}': 'line',
            '{{terms[2][0] | safe }}': 'line',
        }
    },
     bindto: '#chart',
    axis: {
        x: {
            type: 'timeseries',
            tick: {
                format: '%Y'
            }
        }
    },
    legend: {
        show: true,
        position: 'inset',
        inset: 
          {
            anchor: 'top-left',
            x: 10,
            y: 0,
            step: undefined
          },
        item: {
          onmouseout: function (id) {}
        }
    },
    tooltip: {
        grouped: false, // Default true
        format: {
            value: function (value, ratio, id, index) { return value + " articles"; }
        }
    }
});
      
      var facet_count = $(".facet").length;

      $(".facet").each(function(i, id){
        var facet = id.id.replace("-label", "");
        var axis = false;
        if (id.id.replace("-label", "") == "dummy"){
          axis = false;
        }
        make_chart(facet, axis);
      });

      $('.page').on("click", function(e){
        var page = parseInt(this.dataset.page);
        if (this.id == "next"){
          page += 1;
        }else{
          page -= 1;
        }
        get_results(page);
      });


</script>

</body>
</html>