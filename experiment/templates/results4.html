<html>
<head>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.4.5/css/foundation.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.css">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.4.1/js/foundation.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<title>Rookie</title>
{% include 'head.html' %}
</head>

<body>
{% include 'banner.html' %}

<div id="controls" class="row">

  <div>
    <div class="small-10 columns">
      <input id="search_bar" type="text" class="small-12 columns query" placeholder="{{query}}"></input>
    </div>
    <div class="small-2 columns">
      <a href="#" class="button postfix" id="search_button">Search</a>
    </div>
  </div>

</div>

<!--
<div class="toggler row">
    <div class="columns small-3 right" id="datepickers">
      <div class="columns"><p>Start date: <input type="text" id="datepicker1"></p></div>
      <div class="columns"><p>End date: <input type="text" id="datepicker2"></p></div>
    </div>
</div>
-->

<div class="row">
  Related to {{query}} ... <br>
  {% for term in terms%}
     <a id="{{term[0]}}-label" class="term facet tiny button secondary" data-termtype="{{term[1]}}">{{term[0]}}</a>
  {% endfor %}
</div>
<div id="holder">
  <div id="detail-panel">
  </div>
</div>


 
</div>

<style type="text/css">

div#holder {
    margin-left: auto;
    margin-right: auto;
    width: 90%;
}

span{
   font-family: "Courier New"; 
}
span.facet {
    color: darkred;
    font-weight: bolder;
    font-family: "Courier New";
}

</style>

<script type="text/javascript">
$(".facet").on("click", function() {
  var term = this.id.replace("-label", "");
  var termtype = $("[id='" + this.id + "']").attr("data-termtype");
  $.post("get_snippet_post?term=" + term + "&termtype=" + termtype + "&q=" + $("#search_bar").val(), function (data) {
    //$("#last").append(data);
    var json = $.parseJSON(data);
    var counter = 0;
    var char_size = 14;
    $("[id='detail-panel']").html("");
    $.each(json, function () {
        $("[id='detail-panel']").append("<div style='font-size: " + char_size + "px' id='row-" + counter + "' class='main-content'></div>");
        counter += 1;
    });

    var avg_l = 40;
    var avg_c = 40;
    var avg_r = 40;


    var counter = 0;
    $.each(json, function () {
        var insert_l = this.l.join(" ");
        var insert_r = this.r.join(" ");
        var insert_c = this.c.join(" ");
        if (insert_l.length > avg_l){
            insert_l = insert_l.substring(0, avg_l);
        }
        else if (insert_l.length < avg_l){
          var l_before_space = insert_l.length;
          for (i = 0; i < (avg_l - l_before_space); i++) { 
              insert_l = "." + insert_l;
          }
        }
        if (insert_c.length > avg_c){
            insert_c = insert_c.substring(0, avg_c);
        }
        else if (insert_c.length < avg_c){
          var c_before_space = insert_c.length;
          for (i = 0; i < (avg_c - c_before_space); i++) { 
              insert_c = "." + insert_c;
          }
        }
        if (insert_r.length > avg_r){
            insert_r = insert_r.substring(0, avg_r);
        }
        else if (insert_r.length < avg_r){
          var r_before_space = insert_r.length;
          for (i = 0; i < (avg_c - r_before_space); i++) { 
              insert_r = insert_r + ".";
          }
        }
        $("#row-" + counter).html("<span>" + insert_l + "</span><span class='facet'>..." + this.col_l.join(" ") + "...</span><span>" + insert_c + "</span><span class='facet'>..." + this.col_r.join(" ") + "...</span><span>" + insert_r + "</span>");
        counter += 1;
    });

    $(".extract").on("click", function () {
      var docid = this.attributes['data-doc'].value;
      var dataterm = this.attributes['data-term'].value;
      var q = $("#search_bar").val();
      var url = "http://54.191.10.239/detail?q=" + q + "&docid=" + docid + "&t=" + dataterm;
      window.location.href = url;
    });
    bold_q();
  })
});

 jQuery.fn.exists = function(){return this.length>0;}

 if ($("#datepicker1").exists() && $("#datepicker2").exists()){
  $(function() {
    $("#datepicker1").datepicker();
  });
  $(function() {
    $("#datepicker2").datepicker();
  });
}

//wrapper for cloud search
function get_results(start){
    $("#results").html("");
    $("#search_status").html("");
    var term = $("#search_bar").val();
    var url = "http://54.191.10.239/testing?q=" + term;
    window.location.href = url;
}

$('.page').on("click", function(e){
  $("#pages").html("");
  var start_page = parseInt(this.id.replace("page_", ""));
  get_results(start_page);
});

function bold_q(){
  var qtoks = $("#search_bar").val().split(" ");
  for (i = 0; i < qtoks.length; i++) { 
    $("[data-word='" + qtoks[i] + "']").css("font-weight", "bold");
  }
  var elementExists = document.getElementById("search_button");
  if ($('.selected').length > 0){
     var ftoks = $(".selected").first().html().split(" ");
     for (i = 0; i < ftoks.length; i++) { 
       $("[data-word='" + ftoks[i] + "']").addClass("selected");
     }  
  }
}

//stackoverflow.com/questions/923299/how-can-i-detect-when-the-mouse-leaves-the-window
//function addEvent(obj, evt, fn) {
//    if (obj.addEventListener) {
//        obj.addEventListener(evt, fn, false);
//    }
//    else if (obj.attachEvent) {
//        obj.attachEvent("on" + evt, fn);
//    }
//}

//addEvent(document, "mouseout", function(e) {
 //   e = e ? e : window.event;
//    var from = e.relatedTarget || e.toElement;
//    if (!from || from.nodeName == "HTML") {
//       // $('#myModal').foundation('reveal', 'open');
//    }
//});

/*
 $('body').bind('keypress', function(e){
   if ( e.keyCode == 13 ) {
     post_answer()
   }
 });

 $('#enter').on('click', function(e){
     post_answer()
 });
*/


 $('#search_button').on('click', function(){
    get_results(1);
 });
  
 //https://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript 
 (function($) {
    $.QueryString = (function(a) {
        if (a == "") return {};
        var b = {};
        for (var i = 0; i < a.length; ++i)
        {
            var p=a[i].split('=');
            if (p.length != 2) continue;
            b[p[0]] = decodeURIComponent(p[1].replace(/\+/g, " "));
        }
        return b;
    })(window.location.search.substr(1).split('&'))
 })(jQuery);

 $("#search_bar").val($.QueryString["q"]);
 $("#advanced_search").on("click", function(){$(".toggler").toggle()});

 $('body').bind('keypress', function(e){
   if ( e.keyCode == 13 ) {
     get_results(1);
   }
 });

 $(".facet").on("click", function(){
   $(".term").removeClass("selected");
   $("[id='" + this.id + "']").addClass("selected");
 });

 function post_answer(){
   var name = $("#name").val()
  $.post( "/answer/" + name, function( data ) {
   alert(data);
  });
 }

</script>

</body>
</html>
