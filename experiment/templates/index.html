<html>
<head>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.4.5/css/foundation.min.css">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.4.1/js/foundation.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<title>Rookie</title>
{% include 'head.html' %}
</head>

<body>
{% include 'banner.html' %}
<div class="row">

	<div id="myModal" class="reveal-modal" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog">
	  <h2 id="modalTitle">Please don't leave this page during the task</h2>
	  This is a controlled experiment. Turkers who use other resources will not get paid.
	  <a class="close-reveal-modal" aria-label="Close">&#215;</a>
	</div>
</div>

<div class="row">

    <div>
        <input id="search_bar" type="text" class="small-12 columns" placeholder="Search the Lens archive"></input>
    </div>

    <a id="search_button" class="button right">Search</a>

</div>

<div id="explore" class="row">
<p class="panel">
some stuff
</p>
</div>

<script type="text/javascript">

var compiled = _.template('<a href="<%= url %>"><h5 class="headline"><%= headline %></h5><h6 class="subheader"><small><%= url %></small></h6></a><div class="teaser"><%=teaser%> ..</div><br>');

//wrapper for cloud search
function get_results(start){
    $("#results").html("");
    $("#search_status").html("");
    var term = $("#search_bar").val();
    $.post("/search?q=" + encodeURIComponent(term) + "&start=" + encodeURIComponent(String(start)), function(data){
            var hits = data.hits.hit;
            if (data.hits.start > 0){
              $("#search_status").html("Page " + String((data.hits.start / 10) + 1) + " of " + String(Math.ceil(data.hits.found/10)) + ". Total hits: " + String(data.hits.found));
            }else{
              $("#search_status").html("Found " + String(data.hits.found) + " results");
            }
            var pages = _.range(1,Math.ceil(data.hits.found/10) + 1 );
            _.each(pages, function(p){
              $("#pages").append("<span id='page_" + String(p) + "' class='page'>" + String(p) + "<span> ")
            });
            $('.page').on("click", function(e){
               $("#pages").html("");
               var start_page = (parseInt(this.id.replace("page_", "")) - 1) * 10;
               get_results(start_page);
            });
            hits.forEach(function(entry) {
                var teaser_text = entry.fields.text.substring(0,300);
                var h_json = {headline: entry.fields.headline, url:entry.fields.url, teaser: teaser_text}
                var html = compiled(h_json);
                $("#results").append(html);
            });
        }
    );
}

//stackoverflow.com/questions/923299/how-can-i-detect-when-the-mouse-leaves-the-window
function addEvent(obj, evt, fn) {
    if (obj.addEventListener) {
        obj.addEventListener(evt, fn, false);
    }
    else if (obj.attachEvent) {
        obj.attachEvent("on" + evt, fn);
    }
}

addEvent(document, "mouseout", function(e) {
    e = e ? e : window.event;
    var from = e.relatedTarget || e.toElement;
    if (!from || from.nodeName == "HTML") {
       // $('#myModal').foundation('reveal', 'open');
    }
});

/*
 $('body').bind('keypress', function(e){
   if ( e.keyCode == 13 ) {
     post_answer()
   }
 });

 $('#enter').on('click', function(e){
     post_answer()
 });
*/

 function show_explorer(){
  $("#explore").css("display", "block");
 }

 function hide_explorer(){
  $("#explore").css("display", "none");
 }

 $('#search_button').on('click', function(){
    hide_explorer();
    get_results(0);
 });
 

 $('body').bind('keypress', function(e){
   if ( e.keyCode == 13 ) {
     hide_explorer();
     get_results(0);
   }
 });

 function post_answer(){
   var name = $("#name").val()
  $.post( "/answer/" + name, function( data ) {
   alert(data);
  });
 }

</script>

<style type="text/css">

.headline{
  color: #B33125;
}

.teaser{
  font-size: .9em;
}

a#search_button {
    background-color: #B33125;
}

.search_status{
  color: gray;
  font-size: .9em;
}

.page{
  color: #B33125;
}

#explore{
  display: none;
}

</style>

<div class="row">
<div id="search_status"></div>
<div id="results">
</div>

<div class="small-centered small-3 columns" id="pages">
</div>


</div>


<!--
<div class="row">

    <fieldset>
     <legend>Questions</legend>

       <div class="large-12 columns">
         <label>What is your name bro?</label>
         <input id="name" type="text" class="small-12 columns"></input>
       </div>
    </fieldset>

<a id="enter" class="button right">Enter</a>

</div>
-->


</body>
</html>